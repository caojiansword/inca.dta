﻿<!DOCTYPE html>
<html lang="zh-CN" xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8"></meta>
<title>客户管理</title>
<meta
	content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
	name="viewport"></meta>
<link rel="stylesheet"
	href="../../css/bootstrap/dist/css/bootstrap.min.css"></link>
<link rel="stylesheet"
	href="../../css/font-awesome/css/font-awesome.min.css"></link>
<link rel="stylesheet" href="../../css/Ionicons/css/ionicons.min.css"></link>
<link rel="stylesheet"
	href="../../css/datatables.net-bs/css/dataTables.bootstrap.min.css"></link>
<link rel="stylesheet" href="../../css/dist/css/AdminLTE.min.css"></link>
<link rel="stylesheet"
	href="../../css/dist/css/skins/_all-skins.min.css"></link>
<!-- <link rel="stylesheet" type="text/css" href="../../css/fenlei.css"></link>
 --><link rel="stylesheet" type="text/css" th:href="@{/css/miniui.css}" />
<link rel="stylesheet" type="text/css" th:href="@{/css/icons.css}" />
<link rel="stylesheet" type="text/css" th:href="@{/css/skin.css}" />
<link rel="stylesheet" type="text/css"
	th:href="@{/css/font-awesome.min.css}" />
<link rel="stylesheet" type="text/css" th:href="@{/css/setAd.css}" />
<link rel="stylesheet" type="text/css" th:href="@{/css/minicommon.css}" />
<script th:src="@{/js/jquery-1.11.1.js}" type="text/javascript"></script>
<script th:src="@{/js/miniui.js}" type="text/javascript" charset="utf-8"></script>
<script src="../../js/jquery/dist/jquery.min.js"></script>
<script src="../../js/fastclick/lib/fastclick.js"></script>
<script type="text/javascript" src="../../js/paging.js"></script>
<script src="../../js/jquery/dist/jquery.min.js"></script>
<script src="../../js/fastclick/lib/fastclick.js"></script>
<script src="../../js/adminlte.min.js"></script>
<script th:src="@{/js/page-0.0.1.js}" type="text/javascript" charset="utf-8"></script>

<style>
* {
	padding: 0;
	margin: 0;
}
/*
			  * 外面盒子样式---自己定义
			  */
.page_div {
	margin-top: 20px;
	margin-bottom: 20px;
	font-size: 15px;
	font-family: "microsoft yahei";
	color: #666666;
	margin-right: 10px;
	padding-left: 20px;
	box-sizing: border-box;
}
/*
			 * 页数按钮样式
			 */
.page_div a {
	min-width: 30px;
	height: 28px;
	border: 1px solid #dce0e0 !important;
	text-align: center;
	margin: 0 4px;
	cursor: pointer;
	line-height: 28px;
	color: #666666;
	font-size: 13px;
	display: inline-block;
}

#firstPage, #lastPage {
	width: 50px;
	color: #0073A9;
	border: 1px solid #0073A9 !important;
}

#prePage, #nextPage {
	width: 70px;
	color: #0073A9;
	border: 1px solid #0073A9 !important;
}

.page_div .current {
	background-color: #0073A9;
	border-color: #0073A9;
	color: #FFFFFF;
}

.totalPages {
	margin: 0 10px;
}

.totalPages span, .totalSize span {
	color: #0073A9;
	margin: 0 5px;
}

.New_Button, .Edit_Button, .Delete_Button, .Update_Button,
	.Cancel_Button {
	font-size: 11px;
	color: #1B3F91;
	font-family: Verdana;
	margin-right: 5px;
}

.title_show {
	text-overflow: ellipsis;
	overflow: hidden;
	white-space: nowrap;
	width: 200px;
}
.Box{background:#fff;margin:0 auto;padding-bottom:60px;}

</style>
</head>
<body class="hold-transition skin-blue sidebar-mini">
	<div class="wrapper">
		<!--主页面左边菜单和上部分横条公共部分-->
		<script src="../../js/common/left.js"></script>
		<!--结束-->
		<!-- Content Wrapper. Contains page content -->
		<div class="content-wrapper">
			<!-- Content Header (Page header) -->
			<!-- Main content -->
			<section class="content">
				<div class="row">
					<div class="col-xs-12">
						<div class="box" style="overflow: hidden;">
							<h3 class="box-title" style="margin-left: 30px;">客户管理</h3>
							<div class="contTop tc bgf">

								<table style="width: 100%; margin-top: 10px;">
									<tr>
										<td style="white-space: nowrap;" align="left"><span>关键字：</span>
											<input id="keyword" emptyText="客户编码/客户名称" class="mini-textbox"
											style="width: 200px; margin-left: 10px; margin-right: 30px;" />

											 <span>客户类型：</span> <input id="typeQ" 
											class="mini-combobox" renderer="onTypeRenderer"  th:data="${type}" showNullItem="true"   textField="value" valueField="key"
											style="width: 200px; margin-right: 30px;" />
											 <span>状态：</span> <input id="statusQ" 
											class="mini-combobox" renderer="onStatusRenderer"  th:data="${status}" showNullItem="true"   textField="value" valueField="key"
											style="width: 200px; margin-right: 30px;" />
											
											<span
											class="mini-button" plain="true" iconCls="icon-search"
											style="margin-right: 14px;" onclick="search()">查询</span></td>
									</tr>
									<tr></tr>
								</table>
							</div>
							    <div style="width:100%;">
        <div class="mini-toolbar" style="border-bottom:0;padding:14px 10px 2px;">
            <table style="width:100%;">
                <tr>
                    <td style="width:100%;padding-bottom: 6px;">
                        <a class="mini-button" plain="true" iconCls="icon-add" onclick="doAdd()">新增</a>
                        <a class="mini-button" plain="true" iconCls="icon-edit" onclick="doEdit()">编辑</a>
                        <a class="mini-button" plain="true" iconCls="icon-remove" onclick="doRemove()">删除</a>
                        <a class="mini-button" plain="true" iconCls="icon-ok" onclick="doEnable">确定</a>
                        <a class="mini-button" plain="true" iconCls="icon-no" onclick="doStop()">停用</a>
                        <a class="mini-button" plain="true" iconCls="icon-upload" onclick="doExport()">导出</a>
                        <a class="mini-button" plain="true" iconCls="icon-download" onclick="doImport()">导入</a>
                    </td>
                </tr>
            </table>
        </div>
    </div>
        <div id="datagrid" class="mini-datagrid" th:attr="url=@{{funcPath}/search(funcPath=${funcPath})}" idField="id" allowResize="true"
         pageSize="20" showPager="false" multiSelect="true"  selectOnLoad="true" showPagerButtonIcon	="true">
        <div property="columns">
            <div type="indexcolumn" headerAlign="center">行号</div>
            <div type="checkcolumn"></div>
            <div field="id" headerAlign="center" align="center" visible="false">客户ID</div>
            <div field="customerCode" allowSort="true" headerAlign="center" align="center">客户编码</div>
            <div field="customerName" allowSort="true" headerAlign="center" align="center">客户名称</div>
            <div field="domain" allowSort="true" headerAlign="center" align="center" >客户域名</div>
            <div field="orgCode" allowSort="true" headerAlign="center" align="center" >组织机构代码</div>
            <div field="typeView" allowSort="true" headerAlign="center" align="center">客户类型</div>
            <div field="statusView" allowSort="true" headerAlign="center" align="center">状态</div>
            <div field="phoneNo" allowSort="true" headerAlign="center"  align="center">手机号</div>
            <div field="onLineDateView" allowSort="true" headerAlign="center" align="center" dateFormat="yyyy-MM-dd HH:mm:ss" id="start_date">确定日期</div>
            <div field="stopDateView" allowSort="true" headerAlign="center" align="center" dateFormat="yyyy-MM-dd HH:mm:ss" id="end_date">停用日期</div>
            <div field="createTimeView" allowSort="true" headerAlign="center"  align="center" dateFormat="yyyy-MM-dd HH:mm:ss">创建时间</div>
        </div>
    </div>
						</div>
					</div>
				</div>
			</section>
		</div>
		<div class="control-sidebar-bg"></div>
	</div>
	<div id="editWindow" class="mini-window" title="新增/编辑  客户信息" style="width: 800px;" showModal="true" allowResize="true" allowDrag="true">
        <div id="editForm" class="form">
            <input class="mini-hidden" name="id" />
            <table style="width: 100%;border-collapse:separate; border-spacing:0px 10px; "  >
                <tr>
                    <td>客户编码：</td>
                    <td>
                        <input id="customerCode" name="customerCode" class="mini-textbox" style="width: 200px;" required="true"/>
                    </td>
                    <td>客户名称：</td>
                    <td>
                        <input id="customerName" name="customerName" class="mini-textbox" style="width: 200px;" required="true"/>
                    </td>
                   
                </tr>
                <tr>
                    <td>客户域名：</td>
                    <td>
                        <input id="domain" name="domain" class="mini-textbox" style="width: 200px;" required="true" />
                    </td>
                    <td>客户类型：</td>
                    <td>
                   <input id="type" name="type" class="mini-combobox" style="width: 200px;"  th:data="${type}" renderer="onTypeRenderer" showNullItem="true" textField="value" valueField="key" required="true" />
                </td>
                </tr>
                <tr>
                   <td>组织机构代码：</td>
                    <td>
                        <input id="orgCode" name="orgCode" class="mini-textbox" style="width: 200px;" required="false" />
                    </td>
                     <td>手机号：</td>
                    <td>
                        <input id="phoneNo" name="phoneNo" class="mini-textbox" style="width: 200px;" required="false" />
                    </td>
                </tr>
                <tr>
                </tr>
                <tr>
                  <td>状态：</td>
                    <td>
                        <input id="status" name="status" class="mini-combobox" style="width: 200px;" th:data="${status}" renderer="onStatusRenderer" textField="value" valueField="key"  enabled="false"/>
                    </td>
                   <td>创建时间：</td>
                    <td>
                       <input id="createTime" name="createTime" class="mini-datepicker" dateFormat="yyyy-MM-dd HH:mm:ss" style="width: 200px;" enabled="false" required="false" />
                   </td>
                </tr>
                <tr>
                    <td style="text-align: center; padding-top: 20px;padding-bottom:10px;" colspan="4">
                        <a class="mini-button" onclick="save" style="width: 60px; margin-right: 20px;">保存</a>
                        <a class="mini-button" onclick="cancel" style="width: 60px;">取消</a>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <script th:inline="javascript">
        //<![CDATA[
        mini.parse();
        var funcPath=/*[[${funcPath}]]*/;
        $('#datagrid').css({'height':$(window.parent.document).height()-$('.contTop').outerHeight()-210+'px','padding':'0 0 2px 0'})
        var grid = mini.get("datagrid");
        var editWindow = mini.get("editWindow");
        $('#editForm').show();
        $('#ruleform').show();
        //导出
        function doExport(){
            var url = /*[[@{{funcPath}/export(funcPath=${funcPath})}]]*/;
        	$.ajax({
        		url:url,
        		success:function(data){
        			if(data.code=1000){
        				mini.alert(data.result);
        			}else{
        				mini.alert(data.message);
        			}
        			
        		},
        		error:function(data){
        			debugger;
        			mini.alert(data.message);
        		}
        	});
        }
     // 打开导入弹出框
        function doImport() {
        	var url = /*[[@{{funcPath}/importDialog(funcPath=${funcPath})}]]*/;
            mini.open(url);
        }
        // 打开导入弹出框(js因安全問題，不允許訪問本地路徑)
        function doExport_bak() {
        	var url = /*[[@{{funcPath}/exportDialog(funcPath=${funcPath})}]]*/;
            mini.open(url);
        }
        // 查询
        function search(){
        	debugger;
            // 客户名称、域名
            var keyword = mini.get("keyword").getValue();
            // 客户类型
            var type = mini.get("typeQ").getValue();
            //状态
            var status = mini.get("statusQ").getValue();
            grid.load({keyword:keyword,type:type,status:status},function(data){
                setTotalRecord(data.total);
            });
        }

        // 设置分页
        function getMiniGrid(){
            return grid;
        }

        // 点增加按钮
        function doAdd(){
            editWindow.show();
            var eidtform = new mini.Form("#editForm");
            eidtform.clear();
            var createTime = mini.formatDate (new Date(), "yyyy-MM-dd HH:mm:ss");
            //制单时间缺省当前时间
            mini.get("createTime").setValue(createTime);
            // 状态默认为0
            mini.get("status").setValue(0);
            // 客户类型 默认为IBS客户
            mini.get("type").setValue(2);
        }

        // 编辑
        function doEdit(){
            var rows = grid.getSelecteds();
            if (rows.length == 1) {
                var row = rows[0];
                if (row) {
                    var id = row.id;
                    var status = row.status;
                    if (status != 0) {
                        mini.alert("当前记录非临时状态记录,不允许编辑！");
                        return;
                    }
                    if (id) {
                        var editForm = new mini.Form("#editForm");
                        var url = /*[[@{{funcPath}/findCustomserById(funcPath=${funcPath})}]]*/;
                        $.ajax({
                            url:url,
                            data:{id:id},
                            success:function(data){
                                if(data!=null){
                                    var o = mini.decode(data);
                                    editForm.setData(o);
                                    editWindow.show();
                                }
                                
                            },
                            error: function () {
                                mini.alert("表单加载错误");
                                editForm.unmask();
                            }
                        })
                    }
                }
            } else {
                mini.alert("请选中一条数据！")
            }
        }

        // 执行删除操作
        function doRemove(){
            var rows = grid.getSelecteds();
            if (rows.length > 0) {
                var ids = [];
                for (var i = 0, l = rows.length; i < l; i++) {
                    var r = rows[i];
                    ids.push(r.id);
                    var s = r.status;
                    if (s != 0) {
                        mini.alert("所选记录中有非临时状态记录,删除失败！");
                        return;
                    }
                }
                mini.confirm("确定删除？", "确定？",function (action) {
                    if (action == "ok") {
                        var id = ids.join(',');
                        var url = /*[[@{{funcPath}/delleteuser(funcPath=${funcPath})}]]*/;
                        url = url + "?ids=" + id;
                        $.ajax({
                            url: url,
                            success: function (data) {
                                var result = data["result"];
                                var msg = data["msg"];
                            	 if(result!=null&&result){
                                    mini.alert('删除成功！');
                                    grid.reload();
                                } else {
                                	mini.alert(msg);
                                }
                            }
                        });
                    } else {
                        return;
                    }
                });
            } else {
                mini.alert("请选中一条数据！")
            }
        }

        // 取消新增/编辑弹出框
        function cancel() {
            editWindow.hide();
        }

        // 保存
        function save() {
            var form = new mini.Form("#editForm");
            form.validate();
            if (form.isValid() == false) {
            	return;
            }
            
            var messageId = mini.loading("保存中，请稍后......");
            var json2 = mini.encode(form.getData());
            var url = /*[[@{{funcPath}/addsure(funcPath=${funcPath})}]]*/;
            $.ajax({
                type: "POST",
                url: url,
                data: {json:json2},
                success: function (res) {
                    mini.hideMessageBox(messageId);
                    var result = res["success"];
                    var msg = res["msg"];
                    if(result!=null&&result){
                    	mini.alert(msg);
                        editWindow.hide();
                        grid.reload();
                    }else {
                        mini.alert(msg);
                    } 
                },
                 error: function (jqXHR, textStatus, errorThrown) {
                    mini.hideMessageBox(messageId);
                    mini.alert(jqXHR.responseText);
                } 
            });
        }

        // 确定操作
        function doEnable(){
            var rows = grid.getSelecteds();
            if (rows.length <= 0) {
                mini.alert("请选择至少一条数据！")
                return;
            }

            var ids = [];
            for (var i = 0, l = rows.length; i < l; i++) {
                var r = rows[i];
                ids.push(r.id);
            }
            var id =ids.join(',');

            var url = /*[[@{{funcPath}/doOnline(funcPath=${funcPath})}]]*/;
            $.ajax({
                url:url,
                data:{ids:id},
                success: function (res) {
                	 var result = res["success"];
                     var msg = res["msg"];
                    if(result!=null&&result){
                        grid.reload();
                        mini.alert('确定成功！');
                    } else {
                        mini.alert(msg);
                    }
                }
            });
        }

        // 停用操作
        function doStop(){
            var rows = grid.getSelecteds();
            if (rows.length <= 0) {
                mini.alert("请选择至少一条数据！")
                return;
            }

            var ids = [];
            for (var i = 0, l = rows.length; i < l; i++) {
                var r = rows[i];
                if (r.status == 0||r.status == 2) {
                    continue;
                }
                ids.push(r.id);
            }
            var id = ids.join(',');

            var url = /*[[@{{funcPath}/doStop(funcPath=${funcPath})}]]*/;
            $.ajax({
                url:url,
                data:{ids:id},
                success: function (res) {
                	var result = res["success"];
                    var msg = res["msg"];
                    if(result!=null&&result){
                        grid.reload();
                        mini.alert('停用成功！');
                    } else {
                        mini.alert(msg);
                    }
                }
            });
        }
        //客户类型
        var typeJson =/*[[${type}]]*/;
        var type=eval("(" + typeJson + ")");
        var len=type.length;
        function onTypeRenderer(e) {
             for (var i = 0, l = len; i < l; i++) {
                 var g = type[i];
                 if (g.key == e.value) return g.value;
             }
             return "";
         }
      //状态
        var typeJson1 =/*[[${status}]]*/;
        var status=eval("(" + typeJson + ")");
        var len1=status.length;
        function onStatusRenderer(e) {
             for (var i = 0, l = len1; i < l; i++) {
                 var g = status[i];
                 if (g.key == e.value) return g.value;
             }
             return "";
         } 
        //]]>
    </script>
	
</html>
