<!DOCTYPE html>
<html lang="zh-CN" xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8"></meta>
<title>客户管理</title>
<meta
	content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
	name="viewport"></meta>
<link rel="stylesheet"
	href="../../css/bootstrap/dist/css/bootstrap.min.css"></link>
<link rel="stylesheet"
	href="../../css/font-awesome/css/font-awesome.min.css"></link>
<link rel="stylesheet" href="../../css/Ionicons/css/ionicons.min.css"></link>
<link rel="stylesheet"
	href="../../css/datatables.net-bs/css/dataTables.bootstrap.min.css"></link>
<link rel="stylesheet" href="../../css/dist/css/AdminLTE.min.css"></link>
<link rel="stylesheet"
	href="../../css/dist/css/skins/_all-skins.min.css"></link>
<link rel="stylesheet" type="text/css" href="../../css/fenlei.css"></link>
<link rel="stylesheet" type="text/css" th:href="@{/css/miniui.css}" />
<link rel="stylesheet" type="text/css" th:href="@{/css/icons.css}" />
<link rel="stylesheet" type="text/css" th:href="@{/css/skin.css}" />
<link rel="stylesheet" type="text/css"
	th:href="@{/css/font-awesome.min.css}" />
<link rel="stylesheet" type="text/css" th:href="@{/css/setAd.css}" />
<link rel="stylesheet" type="text/css" th:href="@{/css/minicommon.css}" />
<script th:src="@{/js/jquery-1.11.1.js}" type="text/javascript"></script>
<script th:src="@{/js/miniui.js}" type="text/javascript" charset="utf-8"></script>
<script src="../../js/jquery/dist/jquery.min.js"></script>
<script src="../../js/fastclick/lib/fastclick.js"></script>
<script type="text/javascript" src="../../js/paging.js"></script>
<script src="../../js/jquery/dist/jquery.min.js"></script>
<script src="../../js/fastclick/lib/fastclick.js"></script>
<script src="../../js/adminlte.min.js"></script>

<style>
* {
	padding: 0;
	margin: 0;
}
/*
			  * 外面盒子样式---自己定义
			  */
.page_div {
	margin-top: 20px;
	margin-bottom: 20px;
	font-size: 15px;
	font-family: "microsoft yahei";
	color: #666666;
	margin-right: 10px;
	padding-left: 20px;
	box-sizing: border-box;
}
/*
			 * 页数按钮样式
			 */
.page_div a {
	min-width: 30px;
	height: 28px;
	border: 1px solid #dce0e0 !important;
	text-align: center;
	margin: 0 4px;
	cursor: pointer;
	line-height: 28px;
	color: #666666;
	font-size: 13px;
	display: inline-block;
}

#firstPage, #lastPage {
	width: 50px;
	color: #0073A9;
	border: 1px solid #0073A9 !important;
}

#prePage, #nextPage {
	width: 70px;
	color: #0073A9;
	border: 1px solid #0073A9 !important;
}

.page_div .current {
	background-color: #0073A9;
	border-color: #0073A9;
	color: #FFFFFF;
}

.totalPages {
	margin: 0 10px;
}

.totalPages span, .totalSize span {
	color: #0073A9;
	margin: 0 5px;
}

.New_Button, .Edit_Button, .Delete_Button, .Update_Button,
	.Cancel_Button {
	font-size: 11px;
	color: #1B3F91;
	font-family: Verdana;
	margin-right: 5px;
}

.title_show {
	text-overflow: ellipsis;
	overflow: hidden;
	white-space: nowrap;
	width: 200px;
}
</style>
</head>
<body class="hold-transition skin-blue sidebar-mini">
	<div class="wrapper">
		<!--主页面左边菜单和上部分横条公共部分-->
		<script src="../../js/common/left.js"></script>
		<!--结束-->
		<!-- Content Wrapper. Contains page content -->
		<div class="content-wrapper">
			<!-- Content Header (Page header) -->
			<!-- Main content -->
			<section class="content">
				<div class="row">
					<div class="col-xs-12">
						<div class="box" style="overflow: hidden;">
							<h3 class="box-title" style="margin-left: 30px;">客户管理</h3>
							<div class="contTop tc bgf">

								<table style="width: 100%; margin-top: 10px;">
									<tr>
										<td style="white-space: nowrap;" align="left"><span>关键字：</span>
											<input id="keyword" emptyText="编码/名称" class="mini-textbox"
											style="width: 200px; margin-left: 10px; margin-right: 30px;" />

											<span>客户编码：</span> <input id="retailCodeQ" emptyText="客户编码"
											class="mini-textbox"
											style="width: 200px; margin-right: 30px;" /> <span>客户名称：</span>
											<input id="retailNameQ" emptyText="客户名称" class="mini-textbox"
											style="width: 200px; margin-right: 30px;" /> <span
											class="mini-button" plain="true" iconCls="icon-search"
											style="margin-right: 14px;" onclick="search()">查询</span></td>
									</tr>
									<tr></tr>
								</table>
							</div>
							    <div style="width:100%;">
        <div class="mini-toolbar" style="border-bottom:0;padding:14px 10px 2px;">
            <table style="width:100%;">
                <tr>
                    <td style="width:100%;padding-bottom: 6px;">
                        <a class="mini-button" plain="true" iconCls="icon-add" onclick="doAdd()">新增</a>
                        <a class="mini-button" plain="true" iconCls="icon-edit" onclick="doEdit()">编辑</a>
                        <a class="mini-button" plain="true" iconCls="icon-remove" onclick="doRemove()">删除</a>
                        <a class="mini-button" plain="true" iconCls="icon-ok" onclick="doOnline()">上线</a>
                        <a class="mini-button" plain="true" iconCls="icon-no" onclick="doStop()">下线</a>
                        <a class="mini-button" plain="true" iconCls="icon-download" onclick="doAutoImport()">下载商品</a>
                        <a class="mini-button" plain="true" iconCls="icon-upload" onclick="doCreateRetail()">创建线上门店</a>
                        <a class="mini-button" plain="true" iconCls="icon-download" onclick="doRetailDownload()">下载门店</a>
                        <a class="mini-button" plain="true" iconCls="icon-find" onclick="doUpdateO2oRetail()">拉取线上门店</a>
                        <a class="mini-button" plain="true" iconCls="icon-ok" onclick="doSetSaleStatus()">设置可售商品</a>
                        <a class="mini-button" plain="true" iconCls="icon-goto" onclick="doTest()">测试</a>
                    </td>
                </tr>
            </table>
        </div>
    </div>
        <div id="datagrid" class="mini-datagrid" th:attr="url=@{{funcPath}/search(funcPath=${funcPath})}" idField="id" allowResize="true"
         pageSize="20" showPager="false" multiSelect="true"  selectOnLoad="true" showPagerButtonIcon	="true">
        <div property="columns">
            <div type="indexcolumn" headerAlign="center">行号</div>
            <div type="checkcolumn"></div>
            <div field="id" headerAlign="center" align="center" visible="true">客户ID</div>
            <div field="customName" allowSort="true" headerAlign="center" align="center">客户名称</div>
            <div field="domain" allowSort="true" headerAlign="center" align="center" >客户域名</div>
            <div field="status" allowSort="true" headerAlign="center" align="center" renderer="onStatusRenderer">开通状态</div>
            <div field="o2oType" allowSort="true" headerAlign="center" align="center"renderer="onTypeRenderer">业务类型</div>
            <div field="phoneNo" allowSort="true" headerAlign="center"  align="center">手机号</div>
            <div field="onlineDate" allowSort="true" headerAlign="center" align="center" dateFormat="yyyy-MM-dd HH:mm:ss" id="start_date">上线日期</div>
            <div field="stopDate" allowSort="true" headerAlign="center" align="center" dateFormat="yyyy-MM-dd HH:mm:ss" id="end_date">下线日期</div>
            <div field="createTime" allowSort="true" headerAlign="center"  align="center" dateFormat="yyyy-MM-dd HH:mm:ss">创建时间</div>
        </div>
    </div>
    

						</div>
					</div>
				</div>
			</section>
		</div>
		<div class="control-sidebar-bg"></div>
	</div>
	<div id="editWindow" class="mini-window" title="新增/编辑  客户信息" style="width: 800px;" showModal="true" allowResize="true" allowDrag="true">
        <div id="editForm" class="form">
            <input class="mini-hidden" name="id" />
            <table style="width: 100%;">
                <tr>
                    <td>客户名称：</td>
                    <td>
                        <input id="customName" name="customName" class="mini-textbox" style="width: 200px;" required="true"/>
                    </td>
                    <td>客户域名：</td>
                    <td>
                        <input id="domain" name="domain" class="mini-textbox" style="width: 200px;" required="true" />
                    </td>
                </tr>
                <tr>
                    <td>业务类型：</td>
                    <td>
                        <input id="o2oType" name="o2oType" class="mini-combobox" style="width: 200px;" th:data="${busiType}" textField="value" valueField="key" required="true" />
                    </td>

                    <td>开通状态：</td>
                    <td>
                        <input id="status" name="status" class="mini-combobox" style="width: 200px;" th:data="${status}" textField="value" valueField="key" required="true" readonly = "true"/>
                    </td>
                </tr>
                <tr>
                    <td>手机号：</td>
                    <td>
                        <input id="phoneNo" name="phoneNo" class="mini-textbox" style="width: 200px;" required="false" />
                    </td>
                </tr>
                <tr>
                    <td style="text-align: center; padding-top: 20px;padding-bottom:10px;" colspan="4">
                        <a class="mini-button" onclick="save" style="width: 60px; margin-right: 20px;">保存</a>
                        <a class="mini-button" onclick="cancel" style="width: 60px;">取消</a>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <script th:inline="javascript">
        //<![CDATA[
        mini.parse();
        var funcPath=/*[[${funcPath}]]*/;
        $('#datagrid').css({'height':$(window.parent.document).height()-$('.contTop').outerHeight()-210+'px','padding':'0 0 2px 0'})
        var grid = mini.get("datagrid");
        var editWindow = mini.get("editWindow");
        $('#editForm').show();
        $('#ruleform').show();
        // 查询
        function search(){
            // 客户名称、域名
            var keyword = mini.get("keyword").getValue();
            grid.load({keyword:keyword,status:status,o2oType:o2oType},function(data){
                setTotalRecord(data.total);
            });
        }

        // 设置分页
        function getMiniGrid(){
            return grid;
        }

        // 点增加按钮
        function doAdd(){
            editWindow.show();
            var eidtform = new mini.Form("#editForm");
            eidtform.clear();
            // 状态默认为0
            mini.get("status").setValue(0);
            // 开通类型默认为京东到家
            mini.get("o2oType").setValue(1);
        }

        // 编辑
        function doEdit(){
            var rows = grid.getSelecteds();
            if (rows.length == 1) {
                var row = rows[0];
                if (row) {
                    var id = row.id;
                    if (id) {
                        var editForm = new mini.Form("#editForm");
                        var url = /*[[@{{funcPath}/edit(funcPath=${funcPath})}]]*/;
                        $.ajax({
                            url:url,
                            data:{id:id},
                            success:function(data){
                                if(data.success){
                                    var o = mini.decode(data.data);
                                    editForm.setData(o);
                                    editWindow.show();
                                }
                            },
                            error: function () {
                                mini.alert("表单加载错误");
                                editForm.unmask();
                            }
                        })
                    }
                }
            } else {
                mini.alert("请选中一条数据！")
            }
        }

        // 执行删除操作
        function doRemove(){
            var rows = grid.getSelecteds();
            if (rows.length > 0) {
                var ids = [];
                for (var i = 0, l = rows.length; i < l; i++) {
                    var r = rows[i];
                    ids.push(r.id);
                    var s = r.status;
                    if (s != 0) {
                        mini.alert("所选记录中有非临时状态记录,删除失败！");
                        return;
                    }
                }
                mini.confirm("确定删除？", "确定？",function (action) {
                    if (action == "ok") {
                        var id = ids.join(',');
                        var url = /*[[@{{funcPath}/remove(funcPath=${funcPath})}]]*/;
                        url = url + "?ids=" + id;
                        $.ajax({
                            url: url,
                            success: function (data) {
                                if(data.success){
                                    mini.alert('删除成功！');
                                    grid.reload();
                                } else {
                                	mini.alert(data.error);
                                }
                            }
                        });
                    } else {
                        return;
                    }
                });
            } else {
                mini.alert("请选中一条数据！")
            }
        }

        // 取消新增/编辑弹出框
        function cancel() {
            editWindow.hide();
        }

        // 保存
        function save() {
            var form = new mini.Form("#editForm");
            form.validate();
            if (form.isValid() == false) {
            	return;
            }
            
            var messageId = mini.loading("保存中，请稍后......");
            var json = mini.encode(form.getData());
            var url = /*[[@{{funcPath}/save(funcPath=${funcPath})}]]*/;
            $.ajax({
                type: "POST",
                url: url,
                contentType:'application/json',
                data: json,
                success: function (res) {
                    mini.hideMessageBox(messageId);
                    if(res.success){
                        editWindow.hide();
                        grid.reload();
                        mini.alert('保存成功！');
                    } else {
                        mini.alert(res.error);
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    mini.hideMessageBox(messageId);
                    mini.alert(jqXHR.responseText);
                }
            });
        }

        // 上线操作
        function doOnline(){
            var rows = grid.getSelecteds();
            if (rows.length <= 0) {
                mini.alert("请选择至少一条数据！")
                return;
            }

            var ids = [];
            for (var i = 0, l = rows.length; i < l; i++) {
                var r = rows[i];
                ids.push(r.id);
            }
            var id =ids.join(',');

            var url = /*[[@{{funcPath}/doOnline(funcPath=${funcPath})}]]*/;
            $.ajax({
                url:url,
                data:{ids:id},
                success: function (res) {
                    if(res.success){
                        grid.reload();
                        mini.alert('操作成功！');
                    } else {
                        mini.alert(res.error);
                    }
                }
            });
        }

        // 下线操作
        function doStop(){
            var rows = grid.getSelecteds();
            if (rows.length <= 0) {
                mini.alert("请选择至少一条数据！")
                return;
            }

            var ids = [];
            for (var i = 0, l = rows.length; i < l; i++) {
                var r = rows[i];
                if (r.status == 0) {
                    continue;
                }
                ids.push(r.id);
            }
            var id = ids.join(',');

            var url = /*[[@{{funcPath}/doStop(funcPath=${funcPath})}]]*/;
            $.ajax({
                url:url,
                data:{ids:id},
                success: function (res) {
                    if(res.success){
                        grid.reload();
                        mini.alert('操作成功！');
                    } else {
                        mini.alert(res.error);
                    }
                }
            });
        }

       	// 测试操作
        function doTest() {
        	var rows = grid.getSelecteds();
            if (rows.length == 1) {
            	var row = rows[0];
                if (row) {
                    var id = row.id;
                    var o2oType = row.o2oType;
                    if (id) {
                        var messageId = mini.loading("测试中，请稍后......");
                        var url = /*[[@{{funcPath}/doTest(funcPath=${funcPath})}]]*/;
                        $.ajax({
                            url:url,
                            data:{id:id, o2oType:o2oType},
                            success:function(data){
                                mini.hideMessageBox(messageId);
                                if(data.success){
                                	console.info(data.result);
                                	mini.alert('测试结束，测试返回信息：' + data.result);
                                } else {
                                	mini.alert(data.message);
                                }
                            },
                            error: function (jqXHR, textStatus, errorThrown) {
                                mini.hideMessageBox(messageId);
                                mini.alert(jqXHR.responseText);
                            }
                        })
                    }
                }
            	
            } else {
            	mini.alert("进行开通第三方平台业务测试时只能选中一条数据！")
                return;
            }
        }

        // 下载商品--自动导入
        function doAutoImport() {
            var url = /*[[@{{funcPath}/autoImport(funcPath=${funcPath})}]]*/;
            var rows = grid.getSelecteds();
            if (rows.length == 1) {
                var row = rows[0];
                if (row) {
                    if (row.status != 1) {
                        mini.alert("请选择一条上线客户信息！");
                        return;
                    }
                    var messageId = mini.loading("下载中，请稍后......");
                    var id = row.id;
                    if (id) {
                        $.ajax({
                            url:url,
                            data:{id:id},
                            success:function(data){
                            	mini.hideMessageBox(messageId);
                                if(data.success){
                                    mini.alert('操作成功！');
                                } else {
                                    mini.alert(data.error);
                                }
                            },
                            error: function (jqXHR, textStatus, errorThrown) {
                                mini.hideMessageBox(messageId);
                                mini.alert(jqXHR.responseText);
                            }
                        })
                    }
                }

            } else {
                mini.alert("进行客户商品下载只能选中一条上线客户数据！")
                return;
            }
        }

        // 下载门店
        function doRetailDownload() {
            var url = /*[[@{{funcPath}/retailLoad(funcPath=${funcPath})}]]*/;
            var rows = grid.getSelecteds();
            if (rows.length == 1) {
                var row = rows[0];
                if (row) {
                    if (row.status != 1) {
                        mini.alert("请选择一条上线客户信息！");
                        return;
                    }

                    mini.showMessageBox({
                        title: "数据更新方式",
                        iconCls: "icon-help",
                        buttons: ["ok", "no"],
                        message: "下载客户门店信息是否覆盖已有的数据 <br>" +
                        "确定：会覆盖已有的客户门店数据",
                        callback: function (action) {
                            // 覆盖已有数据下载
                            var overrideFlag = false;
                            if ('ok' == action) {
                                overrideFlag = true;
                            }

                            var messageId = mini.loading("下载中，请稍后......");
                            var id = row.id;
                            if (id) {
                                $.ajax({
                                    url:url,
                                    data:{id:id, overrideFlag:overrideFlag},
                                    success:function(data){
                                        mini.hideMessageBox(messageId);
                                        if(data.success){
                                            mini.alert('操作成功！');
                                        } else {
                                            mini.alert(data.error);
                                        }
                                    },
                                    error: function (jqXHR, textStatus, errorThrown) {
                                        mini.hideMessageBox(messageId);
                                        mini.alert(jqXHR.responseText);
                                    }
                                })
                            }
                        }
                    });
                }
            } else {
                mini.alert("进行客户门店下载只能选中一条上线客户数据！")
                return;
            }
        }

        /**
         * 拉取线上门店信息，并更新本地中心平台门店信息
         */
        function doUpdateO2oRetail() {
            mini.showMessageBox({
                title: "拉取线上门店信息",
                iconCls: "icon-help",
                buttons: ["ok", "no"],
                message: "拉取线上门店信息用于更新本地中心平台已上线门店的线上信息<br>" +
                "请问是否拉取更新？",
                callback: function (action) {
                    if (action == "no") {
                        return;
                    }

                    var url = /*[[@{{funcPath}/updateO2oRetail(funcPath=${funcPath})}]]*/;
                    var messageId = mini.loading("拉取更新中，请稍后......");
                    var o2oType = 1;
                    $.ajax({
                        url:url,
                        data:{o2oType: o2oType},
                        success:function(data){
                            mini.hideMessageBox(messageId);
                            if(data.success){
                                mini.alert('操作成功！');
                            } else {
                                mini.alert(data.error);
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            mini.hideMessageBox(messageId);
                            mini.alert(jqXHR.responseText);
                        }
                    });
                }
            });
        }

        // 创建线上门店
        function doCreateRetail() {
            var url = /*[[@{{funcPath}/genRetail(funcPath=${funcPath})}]]*/;
            var rows = grid.getSelecteds();
            if (rows.length == 1) {
                var row = rows[0];
                if (row) {
                    if (row.status != 1) {
                        mini.alert("请选择一条上线客户信息！");
                        return;
                    }

                    var messageId = mini.loading("线上门店生成中......");
                    var id = row.id;
                    if (id) {
                        $.ajax({
                            url:url,
                            data:{id:id},
                            success:function(data){
                                mini.hideMessageBox(messageId);
                                if(data.success){
                                    var warnMsg = data.data;
                                    if (warnMsg.length > 0) {
                                        mini.alert('操作完成【' + data.data + '】');
                                    } else {
                                        mini.alert('操作完成！');
                                    }
                                } else {
                                    mini.alert(data.error);
                                }
                            },
                            error: function (jqXHR, textStatus, errorThrown) {
                                mini.hideMessageBox(messageId);
                                mini.alert(jqXHR.responseText);
                            }
                        })
                    }
                }

            } else {
                mini.alert("进行客户商品下载只能选中一条上线客户数据！")
                return;
            }
        }

        /**
         * 设置可售商品
         */
        function doSetSaleStatus() {
            var rows = grid.getSelecteds();
            if (rows.length == 1) {
                var row = rows[0];
                if (row) {
                    if (row.status != 1) {
                        mini.alert("请选择一条上线客户信息！");
                        return;
                    }
                    // 客户ID
                    var id = row.id;

                    // 选择弹出框
                    mini.showMessageBox({
                        title: "设置方式",
                        iconCls: "icon-help",
                        buttons: ["商品文件", "所有商品", "cancel"],
                        message: "请选择设置此客户线上门店可售状态商品",
                        callback: function (action) {
                            // 取消
                            if (action == 'cancel') {
                                return;
                            }

                            if (action == '商品文件') {
                                var url = /*[[@{{funcPath}/importsale(funcPath=${funcPath})}]]*/;
                                url = url + "?id=" + id;
                                mini.open(url);
                            } else if (action == '所有商品') {
                                var messageId = mini.loading("设置中，请稍后......");
                                var url = /*[[@{{funcPath}/saleStatus(funcPath=${funcPath})}]]*/;
                                $.ajax({
                                    url: url,
                                    data: {customerId: id},
                                    success: function (data) {
                                        mini.hideMessageBox(messageId);
                                        if (data.success) {
                                            mini.alert('操作成功！');
                                        } else {
                                            mini.alert(data.error);
                                        }
                                    },
                                    error: function (jqXHR, textStatus, errorThrown) {
                                        mini.hideMessageBox(messageId);
                                        mini.alert(jqXHR.responseText);
                                    }
                                });
                            }
                        }
                    });
                }
            } else {
                mini.alert("请选中一条上线客户数据！")
                return;
            }
        }



        // 状态渲染
        var statusModel =/*[[${status}]]*/;
        var select_status = eval("(" + statusModel + ")");
        var status_len = select_status.length;
        function onStatusRenderer(e) {
            for (var i = 1, l = status_len; i < l; i++) {
                var g = select_status[i];
                if (g.key == e.value) return g.value;
            }
            return "";
        }

        // 类型渲染
        var o2oTypeModel =/*[[${busiType}]]*/;
        var select_o2oType = eval("(" + o2oTypeModel + ")");
        var o2oType_len = select_o2oType.length;
        function onTypeRenderer(e) {
            for (var i = 1, l = o2oType_len; i < l; i++) {
                var g = select_o2oType[i];
                if (g.key == e.value) return g.value;
            }
            return "";
        }
        //]]>
    </script>
	
</html>
